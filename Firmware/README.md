# GeckoTRX Firmware Guide

GeckoTRX Firmware Repository

## Getting Started

GeckoTRX is a palm-sized Software Defined Radio with a focus on my own education and be a fun project in my spare time. The repository you are looking at is hosting the front assembly of the project, both hardware design files and software source files required to build the project. If you haven't done any programming or software development yet, or just want to download the latest release of the firmware, you may want to have a look at the [Quickstart Guide](#).


## Repository structure

This repository hosts all files related to firmware running on the GeckoTRX. If you are looking for the supporting utility files like Firmware Flasher, those are located in the `utils/` folder and are mostly written in Python. Since microcontrollers of different manufacturers are used, programming is done on a ´per-folder´ basis and grouped by Design Unit - If you are looking for the FrontAssemby firmware, look into the `FrontAssembly/` folder.

To compile and link the firmwares, I tried to rely on open-source compilers to avoid any costly compilers. This [README] serves as an installation guide for all neccessary packages to successfully compile the firmwares for the SDR. My development environment is Linux Mint, so all steps provided are using the apt-based approach as far as package installation is concerned. Most packages, however, are the same on RPM based distributions. 


## Built with 

* [sdcc](http://sdcc.sourceforge.net/) (Version 3.8.0)
 

### Building sdcc

For compilation of the front panel microcontroller, the open source [small device compiler](http://sdcc.sourceforge.net/) and its libraries will be used in conjunction with a make style build environment.
Make is favoured because cmake does not have a proper integration with the sdcc compiler or at least I have not found any that runs without its very own problems. 
Make provides a simple and clean interface and out-of-tree builds which keep the sourcetree clean can be handled easily handled too.

Since the sdcc version 3.5.0 provided by the Mint repositories (at the time of writing) does not include the neccessary headers for the used EFM8BB1 microcontroller, sdcc will be compiled by source.  To do that, the following packages have to be installed to provide the compilation environment:  
```
sudo apt-get install build-essential flex bison libboost-all-dev
```

Next, we download and extract the source files

```
wget --content-disposition -c "https://sourceforge.net/projects/sdcc/files/sdcc/3.8.0/sdcc-src-3.8.0-rc1.tar.bz2"
tar -xvf ./sdcc-src-3.8.0-rc1.tar.bz2
cd ./sdcc-3.8.0-rc1/
```

Since we will be compiling code for the 8051 architecture only, we can instruct `./configure` to disable other architectures and thereby saving some compilation time on older machines:

```
./configure --disable-z80-port --disable-z180-port  --disable-r2k-port --disable-r3ka-port  \
                                --disable-gbz80-port --disable-tlcs90-port --disable-ds390-port  \
                                --disable-ds400-port --disable-pic14-port --disable-pic16-port --disable-hc08-port\
                                --disable-s08-port --disable-stm8-por
``` 

Finally, we can build and install the compiler system-wide using make. There are a lot of cases one does not want to install a compiler built from source system-wide, however, having libraries in the right places makes life a lot easier. 

```
make -j4 && make install
```

For those wanting to keep their system clean, I have provided a Vagrantfile which i provisioned as such that it downloads and installs all neccessary software to compile the firmwares.



## JLink Debug Adapter Driver

To flash the firmware, we will have two choices: Either by using a JTAG Adapter like the JLink from SEGGER or the firmware update method implemented by the main controller which sadly is not implemented yet. Feel free to head over to the [GeckoTRX-Top Repository](#) and contribute!
Using a JLink, drivers need to be installed first. Go to the [Segger Downloads page](https://www.segger.com/downloads/jlink/) and fetch the latest driver suitable for your distribution. To install the driver in an apt based distribution, execute
```
sudo dpkg -i /path/to/JLink_Linux_x86_64.deb
```

This completes your development environment. You can, of course use any JTAG adapter implementation able to communicate with the device. Depending on the adapter, the procedures to download the code into the integrated circuit are diffeent. Please consult the documentation of your devices' manufacturer on how to use it or help extending this document :)

The last step to be able to get the firmware build is to clone the repository using

```
git clone https://github.com/einball/GeckoTRX-Front
cd GeckoTRX-Front/
```

and have fun. That's it! 


### Building the firmware

Since we do not want to clutter the source directories unneccessarily with build files generated by the compiler all over the place, cmake is used to build the firmware in a separate build directorywhich will be created and switched to next:

```
mkdir build/
cd build/
```

Since cmake does not know about the 8051 architecture build process, we need to give it some information about the toolchain using `CMAKE_TOOLCHAIN_FILE` and refer it to the top level folder, where the CMakeLists.txt file is located. 

```
cmake -DCMAKE_TOOLCHAIN_FILE=sdcc-toolchain.cmake ../
```

Now the makefiles should have been generated. To build the firmware, simply run `make` and the compiler will build the project. For other available options, please run `make help`.


### Flashing the firmware


No firmware has been flashed yet. If so, try

```
make flash
```

## Versioning

We use [SemVer](http://semver.org/) for versioning. For the versions available, see the [tags on this repository](https://github.com/your/project/tags). 


## License

This project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details. 

Exceptions to this license rules are specified in the individual files, eg files licensed by the manufacturer (Silabs/Keil) are excluded of the MIT license. Please see the individual files for their licenses.
